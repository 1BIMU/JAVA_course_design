# 客户端文档（面向开发者）

## 概述

重构后的客户端采用了MVC架构，通信协议和数据结构保持不变，但改进了处理流程和响应机制。

> 我改动了消息封装类的修饰类型和相关构造函数，并且有些名字改了，服务端如需测试请回退或统一名字。

## 通信协议

客户端与服务端通信使用自定义的消息封装类 `encap_info`，根据不同的消息类型进行处理：

| 类型值 | 消息类型 | 对应信息类 |
|-------|---------|-----------|
| 1 | 群聊控制消息 | Group_info |
| 2 | 登出消息 | - |
| 3 | 登录消息 | Login_info |
| 4 | 聊天消息 | Chat_info |
| 5 | 注册消息 | Reg_info |
| 6 | 断开连接消息 | - |

## 服务端需要实现的功能

### 1. 用户认证

#### 登录处理
- 接收类型为3的消息，包含 `Login_info` 对象
- 验证用户名和密码
- 返回同样类型为3的消息，设置 `loginSucceessFlag` 为 `true` 或 `false`
- 登录成功时，需在 `Login_info` 中设置当前在线用户列表 `onlineUsers`

#### 注册处理
- 接收类型为5的消息，包含 `Reg_info` 对象
- 检查用户名是否已存在
- 返回同样类型为5的消息，设置 `reg_status` 值：
  - 1: 注册成功
  - 2: 用户名已存在

### 2. 消息处理

#### 私聊消息
- 接收类型为4的消息，包含 `Chat_info` 对象，其中 `isType` 为 `false`
- 检查目标用户是否在线
- 如在线，转发消息给目标用户和发送者
- 如不在线，返回给发送者消息，设置 `transfer_status` 为 `false`

#### 群聊消息
- 接收类型为4的消息，包含 `Chat_info` 对象，其中 `isType` 为 `true`
- 获取群组成员列表
- 过滤出在线成员
- 转发消息给所有在线群组成员

### 3. 群组管理

#### 创建群组
- 接收类型为1的消息，包含 `Group_info` 对象，其中 `establish` 为 `true`
- 生成唯一群组ID
- 保存群组信息和成员列表
- 返回带有群组ID的 `Group_info` 对象给所有群组成员

#### 退出群组
- 接收类型为1的消息，包含 `Group_info` 对象，其中 `exist` 为 `false`
- 从群组成员列表中移除用户
- 如果群组无成员，删除群组
- 否则，通知其他群组成员

#### 更新群组
- 接收类型为1的消息，包含 `Group_info` 对象，其中 `exist` 为 `true`，`establish` 为 `false`
- 更新群组成员列表
- 通知所有群组成员

### 4. 用户状态管理

#### 登出处理
- 接收类型为2的消息
- 从在线用户列表移除用户
- 通知其他在线用户

#### 断开连接处理
- 接收类型为6的消息或检测到连接断开
- 从在线用户列表移除用户
- 通知其他在线用户